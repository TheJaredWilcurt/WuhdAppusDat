<!DOCTYPE html>
<html>
  <head>
    <title>WuhdAppusDat</title>
    <link rel="stylesheet" href="fonts/petrona.css">
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        background: transparent;
        border: 0px;
        margin: 0px;
        padding: 0px;
        overflow: hidden;
        transition: 0.5s ease all;
      }
      body:hover {
        box-shadow: 0px 0px 31px inset rgba(0, 0, 0, 0.29), -1px 0px 4px 2px inset #FFF;
      }
      .app-name {
        font-family: Petrona, georgia;
        text-transform: capitalize;
      }
      .container {
        position: absolute;
        top: 0px;
        left: 0px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        overflow: hidden;
      }
      .drag-on {
        -webkit-app-region: drag;
      }
      .drag-off {
        -webkit-app-region: no-drag;
      }
      nav {
        position: absolute;
        top: 0px;
        display: flex;
        width: 100%;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: 1s ease opacity;
        z-index: 9;
      }
      body:hover nav {
        opacity: 1;
      }
      .grabber {
        width: 80%;
        height: 20px;
        background: rgba(127, 127, 127, 0.3);
        border: 1px solid rgba(180, 180, 180, 0.35);
        border-radius: 6px;
        margin: 0px 10px 0px 0px;
      }
      .window-control {
        background: transparent;
        border: 0px;
        padding: 0px;
        font-size: 39px;
        color: #AAA;
        -webkit-text-stroke: 1px #666;
        vertical-align: 2px;
      }
      .options-icon {
        vertical-align: 6px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <main-nav
        :closing-app="settings.closingApp"
        :system-tray="settings.systemTray"
      ></main-nav>

      <div class="container" :style="backgroundStyles"></div>
      <div class="container">
        <h1 class="app-name" :style="textStyles">
          {{ currentlyInFocusApp }}
        </h1>
      </div>
    </div>

    <script src="scripts/vue.min.js"></script>
    <script src="scripts/http-vue-loader.min.js"></script>
    <script>
      Vue.config.devtools = true;

      const path = window.require('path');
      const settingsHelpers = window.require('./scripts/settings.js');
      const {
        APP_TITLE,
        DEFAULT_INTERVAL,
        MAX_BRIGHTNESS,
        MAX_CONTRAST,
        MAX_SATURATION,
        SATURATION_UPPER_MULTIPLIER
      } = require('./scripts/global-constants.js');

      document.querySelector('title').innerText = APP_TITLE;

      window.App = new Vue({
        el: '#app',
        components: {
          'main-nav': httpVueLoader('components/main-nav.vue')
        },
        data: {
          currentlyInFocusApp: '',
          interval: null,
          settings: {}
        },
        methods: {
          updateInterval: function () {
            if (this.interval) {
              clearInterval(this.interval);
            }
            const amount = (this.settings.updateInterval || DEFAULT_INTERVAL) * 1000;
            this.interval = setInterval(this.setAppName, amount);
          },
          appNameCleanUp: function (fileName) {
            // fix later
            let settings;

            fileName = fileName.split('_').join(' ');
            if (fileName === atob('ZWxlY3Ryb24=')) {
              fileName = atob('RWxlY3Ryb20gKFVzaW5nIDk4JSBvZiBhdmFpbGFibGUgbWVtb3J5KQ==');
            } else {
              fileName = (settings && settings.appMap && settings.appMap[fileName.toLowerCase()]) || fileName;
            }
            return fileName || '';
          },
          setLinuxOrOSXAppName: async function () {
            const activeWin = window.require('active-win');
            let win = await activeWin();
            let fileName = win && win.owner && win.owner.name;
            if (!fileName || typeof(fileName) !== 'string') {
              fileName = '';
            }
            fileName = this.appNameCleanUp(fileName);
            this.currentlyInFocusApp = fileName;
          },
          setWindowsAppName: function () {
            const getActiveProcessName = window.require('windows-active-process').getActiveProcessName;
            let filePath = getActiveProcessName();
            if (!filePath || typeof(filePath) !== 'string') {
              filePath = '';
            }
            let splitPath = filePath.split(path.sep);
            let fileName = splitPath[splitPath.length - 1];
            fileName = fileName.split('.');

            if (fileName.length > 1) {
              fileName.pop();
            }
            fileName = fileName.join('');
            fileName = this.appNameCleanUp(fileName);
            this.currentlyInFocusApp = fileName;
          },
          setAppName: function () {
            if (window.process.platform === 'win32') {
              this.setWindowsAppName();
            } else {
              this.setLinuxOrOSXAppName();
            }
          },
          settingsChanged: function (settings) {
            Object.entries(settings).forEach(([key, value]) => {
              this.$set(this.settings, key, value);
            });

            this.updateInterval();
            window.nw.Window.get().setAlwaysOnTop(!!settings.alwaysOnTop);
            window.nw.Window.get().setVisibleOnAllWorkspaces(!!settings.visibleOnAllWorkspaces);
          },
          convertSettingToPercent: function (value, max) {
            value = parseFloat(value);
            if (value !== 0) {
              value = (max * value) / 100;
            }
            value = value.toFixed(3);
            value = parseFloat(value);
            return value;
          }
        },
        computed: {
          backgroundStyles: function () {
            let backgroundImage = this.settings.backgroundImage;
            const shippedBackgrounds = [
              'images/none.png',
              'images/leaves.png',
              'images/spikes.png',
              'images/bubbles.png'
            ];

            if (
              backgroundImage &&
              !shippedBackgrounds.includes(backgroundImage)
            ) {
              backgroundImage = 'file://' + backgroundImage.split('\\').join('/');
            }
            if (backgroundImage) {
              backgroundImage = 'url("' + backgroundImage + '")';
            }

            let brightness;
            let contrast;
            let hueRotate;
            let saturation;
            if (typeof(this.settings.backgroundHueRotate) === 'number') {
              hueRotate = 'hue-rotate(' + this.settings.backgroundHueRotate + 'deg)';
            }
            if (typeof(this.settings.backgroundBrightness) === 'number') {
              brightness = this.settings.backgroundBrightness;
              brightness = this.convertSettingToPercent(brightness, MAX_BRIGHTNESS)
              brightness = 'brightness(' + brightness + ')';
            }
            if (typeof(this.settings.backgroundContrast) === 'number') {
              contrast = this.settings.backgroundContrast;
              contrast = this.convertSettingToPercent(contrast, MAX_CONTRAST);
              contrast = 'contrast(' + contrast + ')';
            }
            if (typeof(this.settings.backgroundSaturation) === 'number') {
              saturation = this.settings.backgroundSaturation;
              if (saturation > 0) {
                saturation = this.convertSettingToPercent(saturation, MAX_SATURATION / SATURATION_UPPER_MULTIPLIER);
                saturation = saturation + 1;
              } else if (saturation < 0) {
                saturation = (saturation * -1) / 100;
                saturation = 1 - saturation;
              } else {
                saturation = 1;
              }
              saturation = 'saturate(' + saturation + ')';
            }
            let filters = [
              brightness,
              contrast,
              hueRotate,
              saturation
            ].filter(Boolean).join(' ');


            return [
              'background-image:' + backgroundImage,
              'filter:' + filters || 'none'
            ].join(';');
          },
          textStyles: function () {
            let fontItalics = 'normal';
            if (this.settings.fontItalics) {
              fontItalics = 'italic';
            }

            let textShadow = 'none';
            if (this.settings.textShadow === 'white') {
              textShadow = '1px 1px 11px #FFF, 1px 1px 18px #FFF';
            } else if (this.settings.textShadow === 'black') {
              textShadow = '1px 1px 11px #000, 1px 1px 18px #000';
            }

            return [
              'margin-top:' + this.settings.textPosition + 'px',
              'color:' + this.settings.textColor,
              'font-family:' + this.settings.fontFamily,
              'font-size:' + this.settings.fontSize + 'px',
              'font-style:' + fontItalics,
              'font-weight:' + (this.settings.fontWeight * 100),
              'text-shadow:' + textShadow
            ].join(';');
          }
        },
        created: function () {
          this.setAppName();
          const settings = settingsHelpers.getSettings();
          this.settingsChanged(settings);
        }
      });
    </script>
  </body>
</html>
